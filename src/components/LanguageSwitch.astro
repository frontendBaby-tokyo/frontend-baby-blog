---
import { getAlternatePath, type Languages } from '@/i18n/utils'
import { languages } from '@/i18n/ui'

const currentLang = Astro.params.lang as Languages
const currentPath = Astro.url.pathname

// å¯¾è±¡è¨€èªã‚’æ±ºå®šï¼ˆã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ï¼‰
const targetLang: Languages = currentLang === 'ja' ? 'en' : 'ja'
const alternatePath = getAlternatePath(currentPath, currentLang, targetLang)

console.log('Target:', { targetLang, alternatePath })
---

<div class='language-switch' data-current-lang={currentLang}>
	<a
		href={alternatePath}
		class='flex items-center gap-1 text-sm hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200 px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800'
		aria-label={`Switch to ${languages[targetLang]}`}
		title={`Switch to ${languages[targetLang]}`}
	>
		<span class='flag text-lg'>{targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'}</span>
		<span class='lang-text font-medium'>{languages[targetLang]}</span>
	</a>
</div>

<script>
	// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«è¨€èªã‚¹ã‚¤ãƒƒãƒã‚’æ›´æ–°
	function updateLanguageSwitch() {
		const languageMap: { [key: string]: string } = { '/ja/': '/en/', '/en/': '/ja/' }
		const currentPath = window.location.pathname
		const link = document.querySelector('.language-switch a')
		const languageSwitch = document.querySelector('.language-switch')

		if (link && languageSwitch) {
			// ç¾åœ¨ã®è¨€èªã‚’æ¤œå‡º
			const currentLang = currentPath.includes('/ja/') ? 'ja' : 'en'
			const targetLang = currentLang === 'ja' ? 'en' : 'ja'

			// hrefå±æ€§ã‚’æ›´æ–°
			const newPath = currentPath.replace(/\/(ja|en)\//, (match) => languageMap[match])
			link.setAttribute('href', newPath)

			// data-current-langå±æ€§ã‚’æ›´æ–°
			languageSwitch.setAttribute('data-current-lang', currentLang)

			// ãƒ•ãƒ©ã‚°ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
			const flagElement = link.querySelector('.flag')
			const textElement = link.querySelector('.lang-text')

			if (flagElement && textElement) {
				flagElement.textContent = targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'
				textElement.textContent = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'English'

				// aria-labelã¨titleå±æ€§ã‚‚æ›´æ–°
				const targetLanguageName = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'English'
				link.setAttribute('aria-label', `Switch to ${targetLanguageName}`)
				link.setAttribute('title', `Switch to ${targetLanguageName}`)
			}
		}
	}

	// åˆå›èª­ã¿è¾¼ã¿æ™‚
	document.addEventListener('DOMContentLoaded', updateLanguageSwitch)

	// Astroã®ãƒšãƒ¼ã‚¸é·ç§»æ™‚ï¼ˆView TransitionsãŒæœ‰åŠ¹ãªå ´åˆï¼‰
	document.addEventListener('astro:page-load', updateLanguageSwitch)

	// é€šå¸¸ã®ãƒšãƒ¼ã‚¸é·ç§»æ™‚ï¼ˆfallbackï¼‰
	document.addEventListener('astro:after-swap', updateLanguageSwitch)
</script>

<style>
	.language-switch a {
		@apply select-none;
	}

	.language-switch a:hover {
		@apply scale-105;
		transform-origin: center;
	}
</style>
