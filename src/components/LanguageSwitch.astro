---
import { getAlternatePath, type Languages } from '@/i18n/utils'
import { languages } from '@/i18n/ui'

// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®åŸºæœ¬è¨ˆç®—ï¼ˆSSGæœ€é©åŒ–ï¼‰
const currentLang = (Astro.params.lang as Languages) || 'ja' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
const currentPath = Astro.url.pathname

// å¯¾è±¡è¨€èªã‚’æ±ºå®šï¼ˆã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ï¼‰
const targetLang: Languages = currentLang === 'ja' ? 'en' : 'ja'
const alternatePath = getAlternatePath(currentPath, currentLang, targetLang)

// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
const targetLanguageName = languages[targetLang]
const targetFlag = targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'
---

<div class='language-switch' data-current-lang={currentLang} transition:persist='language-switch'>
	<a
		href={alternatePath}
		class='flex items-center gap-1 text-sm hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200 px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800'
		aria-label={`Switch to ${targetLanguageName}`}
		title={`Switch to ${targetLanguageName}`}
		data-target-lang={targetLang}
	>
		<span class='flag text-lg'>{targetFlag}</span>
		<span class='lang-text font-medium'>{targetLanguageName}</span>
	</a>
</div>

<script>
	// SSGæœ€é©åŒ–: ã‚ˆã‚ŠåŠ¹ç‡çš„ãªè¨€èªã‚¹ã‚¤ãƒƒãƒæ›´æ–°
	let isUpdating = false // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ãƒ•ãƒ©ã‚°

	function updateLanguageSwitch() {
		// ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
		if (isUpdating) return
		isUpdating = true

		// æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
		requestAnimationFrame(() => {
			try {
				const currentPath = window.location.pathname
				const link = document.querySelector('.language-switch a') as HTMLAnchorElement
				const languageSwitch = document.querySelector('.language-switch') as HTMLElement

				if (!link || !languageSwitch) {
					console.warn('LanguageSwitch: å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
					return
				}

				// ã‚ˆã‚Šæ­£ç¢ºãªè¨€èªæ¤œå‡º
				const currentLang = detectCurrentLanguage(currentPath)
				const targetLang = currentLang === 'ja' ? 'en' : 'ja'

				// ãƒ‘ã‚¹å¤‰æ›ï¼ˆã‚ˆã‚Šå …ç‰¢ãªå®Ÿè£…ï¼‰
				const newPath = generateAlternatePath(currentPath, currentLang, targetLang)

				// DOMæ›´æ–°ï¼ˆãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡åŒ–ï¼‰
				updateDOMElements(link, languageSwitch, currentLang, targetLang, newPath)
			} catch (error) {
				console.error('LanguageSwitchæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error)
			} finally {
				isUpdating = false
			}
		})
	}

	// è¨€èªæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œï¼‰
	function detectCurrentLanguage(path: string): 'ja' | 'en' {
		if (path.includes('/ja/') || path.endsWith('/ja')) return 'ja'
		if (path.includes('/en/') || path.endsWith('/en')) return 'en'

		// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªï¼ˆSSGã®è¨­å®šã«åˆã‚ã›ã‚‹ï¼‰
		return 'ja'
	}

	// ãƒ‘ã‚¹ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå …ç‰¢ï¼‰
	function generateAlternatePath(currentPath: string, fromLang: string, toLang: string): string {
		// ãƒ™ãƒ¼ã‚¹URLè€ƒæ…®
		const basePath = currentPath.replace(/\/(ja|en)(\/|$)/, `/${toLang}/`)

		// æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®æ­£è¦åŒ–
		if (basePath.endsWith('/') && basePath !== '/') {
			return basePath
		}

		return basePath.endsWith('/') ? basePath : basePath + '/'
	}

	// DOMæ›´æ–°å‡¦ç†ï¼ˆãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡åŒ–ï¼‰
	function updateDOMElements(
		link: HTMLAnchorElement,
		container: HTMLElement,
		currentLang: string,
		targetLang: string,
		newPath: string
	) {
		const targetLanguageName = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'English'
		const targetFlag = targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'

		// ãƒãƒƒãƒDOMæ›´æ–°
		link.href = newPath
		link.setAttribute('aria-label', `Switch to ${targetLanguageName}`)
		link.setAttribute('title', `Switch to ${targetLanguageName}`)
		link.setAttribute('data-target-lang', targetLang)
		container.setAttribute('data-current-lang', currentLang)

		// å­è¦ç´ æ›´æ–°
		const flagElement = link.querySelector('.flag')
		const textElement = link.querySelector('.lang-text')

		if (flagElement) flagElement.textContent = targetFlag
		if (textElement) textElement.textContent = targetLanguageName
	}

	// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆSSGæœ€é©åŒ–ï¼‰
	document.addEventListener('DOMContentLoaded', updateLanguageSwitch)

	// Astro View Transitionså¯¾å¿œ
	document.addEventListener('astro:page-load', updateLanguageSwitch)
	document.addEventListener('astro:after-swap', updateLanguageSwitch)

	// å±¥æ­´å¤‰æ›´å¯¾å¿œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ï¼‰
	window.addEventListener('popstate', updateLanguageSwitch)
</script>

<style>
	.language-switch a {
		@apply select-none;
	}

	.language-switch a:hover {
		@apply scale-105;
		transform-origin: center;
	}
</style>
