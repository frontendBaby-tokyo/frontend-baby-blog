---
import { getLangFromUrl, getAlternatePath, type Languages } from '@/i18n/utils'
import { languages, defaultLang } from '@/i18n/ui'

const currentLang = getLangFromUrl(Astro.url)
const currentPath = Astro.url.pathname

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ç”¨ï¼‰
console.log('Debug LanguageSwitch:', {
	url: Astro.url.pathname,
	currentLang,
	currentPath,
	defaultLang
})

// å¯¾è±¡è¨€èªã‚’æ±ºå®šï¼ˆã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ï¼‰
const targetLang: Languages = currentLang === 'ja' ? 'en' : 'ja'
const alternatePath = getAlternatePath(currentPath, currentLang, targetLang)

console.log('Target:', { targetLang, alternatePath })
---

<div class='language-switch' data-current-lang={currentLang}>
	<a
		href={alternatePath}
		class='flex items-center gap-1 text-sm hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200 px-2 py-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800'
		aria-label={`Switch to ${languages[targetLang]}`}
		title={`Switch to ${languages[targetLang]}`}
	>
		<span class='flag text-lg'>{targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'}</span>
		<span class='lang-text font-medium'>{languages[targetLang]}</span>
	</a>
</div>

<script>
	// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«è¨€èªã‚¹ã‚¤ãƒƒãƒã‚’æ›´æ–°
	function updateLanguageSwitch() {
		const currentPath = window.location.pathname
		const isJapanese = currentPath.startsWith('/ja') || currentPath === '/'
		const currentLang = isJapanese ? 'ja' : 'en'
		const targetLang = currentLang === 'ja' ? 'en' : 'ja'

		const languageSwitch = document.querySelector('.language-switch')
		const flagSpan = languageSwitch?.querySelector('.flag')
		const textSpan = languageSwitch?.querySelector('.lang-text')
		const link = languageSwitch?.querySelector('a')

		if (languageSwitch && flagSpan && textSpan && link) {
			// ç¾åœ¨ã®è¨€èªã‚’dataå±æ€§ã«è¨­å®š
			languageSwitch.setAttribute('data-current-lang', currentLang)

			// ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨€èªã«å¿œã˜ã¦è¡¨ç¤ºã‚’æ›´æ–°
			flagSpan.textContent = targetLang === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 'ğŸ‡ºğŸ‡¸'
			textSpan.textContent = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'English'

			// ãƒªãƒ³ã‚¯ã®hrefã‚’æ›´æ–°
			const pathWithoutLang = currentPath.replace(/^\/(ja|en)/, '') || '/'
			const newPath = `/${targetLang}${pathWithoutLang}`
			link.setAttribute('href', newPath)

			// ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã‚‚æ›´æ–°
			const langName = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'English'
			link.setAttribute('aria-label', `Switch to ${langName}`)
			link.setAttribute('title', `Switch to ${langName}`)
		}
	}

	// åˆå›èª­ã¿è¾¼ã¿æ™‚
	document.addEventListener('DOMContentLoaded', updateLanguageSwitch)

	// Astroã®ãƒšãƒ¼ã‚¸é·ç§»æ™‚ï¼ˆView TransitionsãŒæœ‰åŠ¹ãªå ´åˆï¼‰
	document.addEventListener('astro:page-load', updateLanguageSwitch)

	// é€šå¸¸ã®ãƒšãƒ¼ã‚¸é·ç§»æ™‚ï¼ˆfallbackï¼‰
	document.addEventListener('astro:after-swap', updateLanguageSwitch)
</script>

<style>
	.language-switch a {
		@apply select-none;
	}

	.language-switch a:hover {
		@apply scale-105;
		transform-origin: center;
	}
</style>
